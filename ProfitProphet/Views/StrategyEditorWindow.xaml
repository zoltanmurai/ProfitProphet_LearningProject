<Window x:Class="ProfitProphet.Views.StrategyEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:ProfitProphet.Converters"
        mc:Ignorable="d"
        Title="Stratégia Szerkesztő (Profi Mód)" Height="700" Width="1280"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource PrimaryBackground}" 
        Foreground="{DynamicResource PrimaryText}">

    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>

        <DataTemplate x:Key="RuleTemplate">
            <Border Background="{DynamicResource SecondaryBackground}" 
                    BorderBrush="{DynamicResource BorderBrush}" 
                    BorderThickness="0,0,0,1" 
                    Margin="0,1" 
                    Padding="5">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="1.5*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="1.2*"/>
                        <ColumnDefinition Width="1.2*"/>
                        <ColumnDefinition Width="2.5*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="30"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Text="ÉS" 
                             VerticalAlignment="Center" 
                             Foreground="{DynamicResource AccentBrush}" 
                             FontWeight="Bold" 
                             Margin="0,0,10,0"/>

                    <ComboBox Grid.Column="1" 
                              ItemsSource="{Binding DataContext.AvailableIndicators, RelativeSource={RelativeSource AncestorType=Window}}"
                              SelectedItem="{Binding LeftIndicatorName}" 
                              Margin="0,0,5,0"/>

                    <StackPanel Grid.Column="2" 
                                Orientation="Horizontal" 
                                Margin="0,0,10,0" 
                                VerticalAlignment="Center">
                        <TextBox Text="{Binding LeftPeriod}" 
                                 Width="40" Margin="0,0,2,0" 
                                 ToolTip="Period 1 / Fast / Length" 
                                 TextAlignment="Center"/>
                        <TextBox Text="{Binding LeftParameter2}" 
                                 Width="40" Margin="0,0,2,0" 
                                 ToolTip="Period 2 / Slow / Deviation" 
                                 TextAlignment="Center"
                                 Visibility="{Binding ShowLeftParam2, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        <TextBox Text="{Binding LeftParameter3}" 
                                 Width="40" Margin="0,0,2,0" 
                                 ToolTip="Period 3 / Signal / Slowing" 
                                 TextAlignment="Center"
                                 Visibility="{Binding ShowLeftParam3, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </StackPanel>

                    <ComboBox Grid.Column="3" 
                              ItemsSource="{Binding DataContext.AvailableOperators, RelativeSource={RelativeSource AncestorType=Window}}"
                              SelectedItem="{Binding Operator}" 
                              Margin="0,0,10,0"/>

                    <ComboBox Grid.Column="4" 
                              ItemsSource="{Binding DataContext.AvailableSourceTypes, RelativeSource={RelativeSource AncestorType=Window}}"
                              SelectedItem="{Binding RightSourceType}" 
                              Margin="0,0,10,0"/>

                    <Grid Grid.Column="5">
                        <TextBox Text="{Binding RightValue}" 
                                 Visibility="{Binding IsRightSideIndicator, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>

                        <StackPanel Orientation="Horizontal" 
                                    Visibility="{Binding IsRightSideIndicator, Converter={StaticResource BoolToVisibilityConverter}}">
                            <ComboBox ItemsSource="{Binding AllowedRightIndicators}" 
                                      SelectedItem="{Binding RightIndicatorName}" 
                                      Width="100" Margin="0,0,5,0"/>
                            <TextBox Text="{Binding RightPeriod}" 
                                     Width="40" Margin="0,0,2,0" 
                                     ToolTip="Period 1" TextAlignment="Center"/>
                            <TextBox Text="{Binding RightParameter2}" 
                                     Width="40" Margin="0,0,2,0" 
                                     ToolTip="Period 2" TextAlignment="Center"
                                     Visibility="{Binding ShowRightParam2, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            <TextBox Text="{Binding RightParameter3}" 
                                     Width="40" Margin="0,0,2,0" 
                                     ToolTip="Period 3" TextAlignment="Center"
                                     Visibility="{Binding ShowRightParam3, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        </StackPanel>
                    </Grid>

                    <StackPanel Grid.Column="6" 
                                Orientation="Horizontal" 
                                VerticalAlignment="Center" 
                                Margin="5,0">
                        <TextBlock Text="Shift:" 
                                   Foreground="{DynamicResource SecondaryText}" 
                                   VerticalAlignment="Center" 
                                   Margin="0,0,3,0" 
                                   FontSize="10"/>
                        <TextBox Text="{Binding Shift}" 
                                 Width="30" 
                                 ToolTip="Mennyivel nézzük vissza a múltat? (0=most, 1=előző gyertya)" 
                                 TextAlignment="Center"/>
                    </StackPanel>

                    <Button Grid.Column="7" 
                            Content="🗑" 
                            Background="Transparent" 
                            BorderThickness="0" 
                            Foreground="#FF5555"
                            Command="{Binding DataContext.RemoveRuleCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                            CommandParameter="{Binding}"/>
                </Grid>
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="GroupTemplate">
            <Border Background="{DynamicResource TertiaryBackground}" 
                    BorderBrush="{DynamicResource BorderBrush}" 
                    BorderThickness="1" 
                    CornerRadius="5" 
                    Margin="0,0,0,15" 
                    Padding="10">
                <StackPanel>
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Orientation="Horizontal">

                            <TextBlock Text="VAGY" 
                                       FontWeight="Bold" 
                                       Foreground="{DynamicResource StrategyOrBrush}" 
                                       VerticalAlignment="Center" 
                                       Margin="0,0,10,0" 
                                       FontSize="14"/>

                            <TextBlock Text="Csoport Neve:" 
                                       VerticalAlignment="Center" 
                                       Foreground="{DynamicResource SecondaryText}" 
                                       Margin="0,0,5,0"/>
                            <TextBox Text="{Binding Name}" 
                                       Width="200"/>

                        </StackPanel>

                        <Button Grid.Column="1" 
                                Content="💾 Mentés" 
                                Margin="0,0,10,0"
                                Background="Transparent" 
                                BorderThickness="0" 
                                Foreground="{DynamicResource AccentBrush}" 
                                FontWeight="Bold"
                                HorizontalAlignment="Right"
                                Command="{Binding DataContext.SaveGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                CommandParameter="{Binding}"/>
                        <Button Grid.Column="2" 
                                Content="🗑 Csoport Törlése" 
                                Background="Transparent" 
                                BorderThickness="0" 
                                Foreground="#FF5555" 
                                FontWeight="Bold"
                                Command="{Binding DataContext.RemoveGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                CommandParameter="{Binding}"/>
                    </Grid>

                    <ItemsControl ItemsSource="{Binding Rules}" ItemTemplate="{StaticResource RuleTemplate}"/>

                    <Button Content="+ ÉS Szabály hozzáadása" 
                            HorizontalAlignment="Left" 
                            Margin="30,5,0,0" 
                            Padding="10,2"
                            Background="Transparent" 
                            BorderBrush="{DynamicResource AccentBrush}" 
                            Foreground="{DynamicResource AccentBrush}" 
                            BorderThickness="1"
                            Command="{Binding DataContext.AddRuleToGroupCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                            CommandParameter="{Binding}"/>
                </StackPanel>
            </Border>
        </DataTemplate>
    </Window.Resources>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" Margin="0,0,0,10">
            <TextBlock Text="Stratégia Szerkesztő (Profi Mód)" 
                       FontSize="22" 
                       FontWeight="Bold" 
                       Foreground="{DynamicResource PrimaryText}"/>
            <TextBlock Text="A csoportok között VAGY kapcsolat, a csoportokon belül ÉS kapcsolat van." 
                       Foreground="{DynamicResource SecondaryText}" 
                       FontStyle="Italic"/>

            <StackPanel Orientation="Vertical" Margin="0,0,0,0">
                <TextBlock Text="Extra beállítások:" 
                           Foreground="{DynamicResource PrimaryText}" 
                           FontStyle="Italic" 
                           Margin="0,10,0,0"/>
                <CheckBox Content="Rávásárlás engedélyezése (Pyramiding)" 
                          IsChecked="{Binding Profile.AllowPyramiding}" 
                          Foreground="{DynamicResource PrimaryText}" 
                          Margin="10,0,20,0"/>

                <CheckBox Content="Csak Profitban Zárás" 
                          IsChecked="{Binding Profile.OnlySellInProfit}" 
                          Foreground="{DynamicResource PrimaryText}" 
                          ToolTip="Csak akkor ad el jelzésre, ha az árfolyam > átlagár + költségek" 
                          Margin="10,0,20,0"/>
            </StackPanel>
        </StackPanel>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="20"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <GroupBox Grid.Column="0" 
                      Header="Vételi Setupok (Entry)" 
                      BorderBrush="{DynamicResource StrategyBuyBrush}" 
                      Foreground="{DynamicResource StrategyBuyBrush}">
                <DockPanel>
                    <UniformGrid DockPanel.Dock="Bottom" Rows="1" Columns="2" Margin="0,10,0,0">
                        <Button Content="📂 Setup Betöltése..." 
                            Command="{Binding LoadEntryGroupCommand}"
                            Background="{DynamicResource TertiaryBackground}" 
                            Foreground="{DynamicResource SecondaryText}" 
                            Margin="0,0,5,0" 
                            Padding="10" 
                            FontWeight="SemiBold"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"/>

                        <Button Content="+ Új Üres Csoport" 
                            Command="{Binding AddEntryGroupCommand}"
                            Background="{DynamicResource TertiaryBackground}" 
                            Foreground="LimeGreen" 
                            Margin="5,0,0,0" 
                            Padding="10" 
                            FontWeight="Bold"
                            BorderBrush="LimeGreen"
                            BorderThickness="1"/>
                        </UniformGrid>

                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding EntryGroups}" ItemTemplate="{StaticResource GroupTemplate}"/>
                    </ScrollViewer>
                </DockPanel>
            </GroupBox>

            <GroupBox Grid.Column="2" 
                      Header="Eladási Setupok (Exit)" 
                      BorderBrush="{DynamicResource StrategySellBrush}" 
                      Foreground="{DynamicResource StrategySellBrush}">
                <DockPanel>
                    <UniformGrid DockPanel.Dock="Bottom" Rows="1" Columns="2" Margin="0,10,0,0">
                        <Button Content="📂 Setup Betöltése..." 
                            Command="{Binding LoadExitGroupCommand}"
                            Background="{DynamicResource TertiaryBackground}" 
                            Foreground="{DynamicResource SecondaryText}" 
                            Margin="0,0,5,0" 
                            Padding="10" 
                            FontWeight="SemiBold"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"/>

                        <Button Content="+ Új Üres Csoport" 
                            Command="{Binding AddExitGroupCommand}"
                            Background="{DynamicResource TertiaryBackground}" 
                            Foreground="Red" 
                            Margin="5,0,0,0" 
                            Padding="10" 
                            FontWeight="Bold"
                            BorderBrush="Red"
                            BorderThickness="1"/>
                    </UniformGrid>

                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{Binding ExitGroups}" ItemTemplate="{StaticResource GroupTemplate}"/>
                    </ScrollViewer>
                </DockPanel>
            </GroupBox>
        </Grid>

        <StackPanel Grid.Row="2" 
                    Orientation="Horizontal" 
                    HorizontalAlignment="Right" 
                    Margin="0,15,0,0">
            <Button Content="Mégse" 
                    IsCancel="True" 
                    Command="{Binding CancelCommand}" 
                    Width="80" 
                    Height="30" 
                    Margin="0,0,10,0" 
                    Background="{DynamicResource TertiaryBackground}" 
                    Foreground="{DynamicResource PrimaryText}"
                    BorderBrush="{DynamicResource BorderBrush}"/>

            <Button Content="MENTÉS" 
                    Command="{Binding SaveCommand}" 
                    Width="80" 
                    Height="30" 
                    Background="{DynamicResource AccentBrush}" 
                    Foreground="White" 
                    FontWeight="Bold"
                    BorderThickness="0"/>
        </StackPanel>
    </Grid>
</Window>